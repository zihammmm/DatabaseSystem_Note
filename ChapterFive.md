# 五、事务处理、并发控制与故障恢复技术

## 5.1事务处理

### 5.1.1事务
+ 事务
> 由某个用户所执行的一个不能被打断的对数据库的操作序列被称为"事务"  

  - 是应用程序访问数据库的**基本逻辑工作单位**
  - 执行过程按照预定的次序顺序执行
  - 执行过程的串行。在执行过程中，数据库中的数据可能有不一致的现象，在执行结束时，系统将保证数据库中数据的一致性。


### 5.1.2事务的性质
ACID特性：
+ 原子性
> 在一个事务中，所有的数据库访问操作构成一个不可分割的操作序列，这些操作要么全部执行结束，要么一个都不要执行。
+ 一致性
> 一个事务的成功执行总是将数据库从一个一致的状态转换到另一个一致的状态  

要求数据库中的数据满足:  
  - 在数据库中显式定义的各种完整性约束
  - 用户心目中的隐式数据约束

事务的一致性由两方面完成： 
  - DBMS中的**数据完整性保护子系统**
  - 编写事务的应用程序员

+ 隔离性
> 一个事务的执行与并发执行的其他事务之间是相互独立的，互不干扰。  

隔离性的要求：
> 多个事务并发执行的最终结果，应该与它们的某种串行执行的最终结果相等(并发事务的可串行化)  

事务执行的'隔离性'是由DBMS的**并发控制子系统**来实现。
> 当多个事务并发执行时，每个事务都可以看成只有自己在执行。只有当它与其他事务发生封锁冲突时，才会感觉到其他事务的存在。  

+ 持久性
> 一个事务一旦完成其全部操作后，它对数据库的所有更新应永久地反映在数据库中，即使以后系统发生故障也应该能够通过故障恢复来保留这个事务的执行结果  

是由DBMS的**恢复管理子系统**实现的。 

![](/images/5.1.2.1.png)
### 5.1.3事务活动
![](/images/5.1.3.1.png)
+ '活动'状态
> 事务在开始执行后，立即进入“活动”状态。在“活动”状态中，事务将执行对数据库的访问操作  
+ 读操作
  - 将数据读入用户事务的私有工作区间
  - 如果该数据当前不在DBMS的系统缓冲区中，那么DBMS首先将该数据从磁盘读入系统缓冲区，然后再将其拷贝到用户事务的私有工作区  
+ 写操作
  - 降修改后的数据写入数据库
  - 很可能暂时存放在DBMS的系统缓冲区中

+ 预提交状态  
> 当事务的最后一条访问语句执行结束之后，事务进入预提交状态。其对于数据的修改结果可能还在内存的系统缓冲区中，必须将其真正写入数据库的磁盘。  
  - 在所有写磁盘操作执行结束后，事务就进入提交状态  
  - 在预提交失败后，当前事务也将被放弃，事务转而进入失败状态。
  
+ 失败状态
> 处于活动状态的事务在顺利到达并执行完最后一条语句之前就中止执行，或者在预提交状态下因发生系统故障而中止执行。  
  - 事务从活动->失败的原因：
    * 应用程序(或用户)主动放弃当前事务
    * 因并发控制的原因而被放弃的事务(封锁申请的超时等待，死锁)
    * 发生系统故障
  - 事务从'预提交'状态转变为'失败'状态的原因
    * 发生系统故障

+ 异常中止状态
> 处于失败状态的事务，很可能已对磁盘中的数据进行了一部分修改。喂了保证事务的原子性，系统应该撤销该事务对数据库已作的修改。在撤销操作完成以后，事务将被打上一个放弃的标志，转而进入'异常中止'状态。  
  - 回退
    * 对事务的撤销操作也称为事务的回退或回滚
    * 事务的回退由DBMS的恢复子系统实现。
  - 在事务进入'异常中止'状态后，系统有两种选择
    * 作为一个新的事务，重新启动
    * 取消事务

+ 提交状态
  - 事务进入'预提交'状态，并发控制子系统将检查该事务与并发执行的其他事务之间是否发生干扰现象。
  - 在检查通过以后，系统执行提交操作，把对数据库的修改全部写在磁盘上，并通知系统，事务已成功地结束
  - 为事务打上一个提交标志，事务就进入'提交'状态。

**提交和异常中止都意味着一个事务的执行结束**

### 5.1.4有关事务的语句
事务除了一组对于数据库的访问操作构成以外，还包括少量的事务控制语句，用于定义一个事务的开始和结束。

#### 事务的开始
事务的启动是隐式的。可以通过三种方式来启动一个新的事务。 
+ 数据定义命令(DDL)
  - 每一条数据定义命令都将被作为一个单独的事务来执行
  - 在此之前的用户事务将被自动提交
+ 将系统设为自动提交方式(打开自动提交状态)
  - 每一条数据库访问命令都将被作为一个单独的事务来执行，并根据执行结果自动提交或回退
+ 数据操纵命令(DML)
  - 在当前用户的前一个事务执行结束之后，在用户提交的下一条数据库访问操作之前，数据库管理系统将自动启动一个新的事务
#### 事务的结束
+ 正常结束
  - 提交事务
    > 提交当前事务，事务在执行过程中对于数据库的所有修改操作都将被永久地反应到数据库中，并且不可被取消  
    
  可能失败： 
    * 发生系统故障
    * 在提交阶段执行的数据完整性检查  
    
  在事务提交失败后可以通过回退来取消当前事务。  
  由系统自动提交的事务，如果提交失败，系统将自动执行事务的回退操作。
+ 非正常结束
  - 回退事务
  > 取消在该事务执行过程中的所有操作，回滚该事务至事务的起点，以便重新执行或放弃事务。  

  检查点
    * 在事务的执行过程中，系统可以为该事务设置若干个检查点
    * 用户事务可以使用rollback命令将当前事务回退到前面的某个检查点sp，放弃“在检查点sp之后，回退操作之前”的所有访问操作，并继续执行当前事务。
    * 不带检查点的回退操作将结束并放弃整个事务

#### 与事务有关的控制命令(DCL)
+ 设置事务的自动提交命令
> SET AUTO COMMIT ON|OFF  
+ 设置事务的类型
> SET TRANSACTION READONLY|READWRITE  

定义在这之后启动的所有事务在执行过程中对数据库的访问方式。  
读写型事务是事务的缺省类型定义。
+ 设置事务的隔离级别
> SET TRANSACTION ISOLATION LEVEL READUNCOMMITTED|READCOMMITTED|READREPEATABLE|SERIALIZABLE
### 5.1.5事务的组成